<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Laporan Pemesanan (Admin)</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        main {
            padding: 24px;
            max-width: 1000px;
            margin: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        
        table th,
        table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        
        .filter {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .filter input,
        .filter select {
            padding: 6px;
            font-size: 14px;
        }
        
        .status {
            font-weight: 600;
            color: var(--primary);
        }
        
        .export {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .rekap {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 16px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .rekap-item {
            flex: 1;
            min-width: 180px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
        }
        
        .rekap-item span {
            display: block;
            font-size: 18px;
            color: black;
            margin-top: 4px;
        }
        
        #chartStatus {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 24px auto;
        }
        /* Modal detail pesanan */
        
        #detailModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            z-index: 99;
        }
        
        #detailBox {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        #detailBox h3 {
            margin-top: 0;
        }
        
        #detailBox table {
            width: 100%;
            margin-top: 8px;
            border-collapse: collapse;
        }
        
        #detailBox th,
        #detailBox td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: left;
            font-size: 14px;
        }
        
        #closeDetail {
            margin-top: 12px;
            float: right;
        }
        
        @media print {
            header,
            footer,
            .filter,
            .export,
            #chartStatus,
            #detailModal {
                display: none;
            }
            table {
                font-size: 12px;
                border: 1px solid #444;
            }
            table th,
            table td {
                border: 1px solid #444;
                padding: 6px;
            }
            body {
                margin: 20px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>üìä Laporan Pemesanan</h1>
        <div class="user-info"><button class="btn btn-outline" onclick="location.href='dashboard.html'">Kembali</button></div>
    </header>

    <main>
        <canvas id="chartStatus"></canvas>

        <div class="rekap">
            <div class="rekap-item">Total Pesanan <span id="rekapPesanan">0</span></div>
            <div class="rekap-item">Total Buku Dipesan <span id="rekapJumlah">0</span></div>
            <div class="rekap-item">Total Pendapatan <span id="rekapPendapatan">Rp 0</span></div>
        </div>

        <div class="filter">
            <label>üîç Cari Nama:</label><input type="text" id="cariNama" placeholder="ketik nama...">
            <label>üì¶ Filter Status:</label>
            <select id="filterStatus">
        <option value="">Semua</option>
        <option>Menunggu Konfirmasi</option>
        <option>Dalam Proses</option>
        <option>Dikirim</option>
        <option>Selesai</option>
      </select>
        </div>

        <table id="tabelLaporan">
            <thead>
                <tr>
                    <th>Kode DO</th>
                    <th>Nama</th>
                    <th>Tanggal</th>
                    <th>Jumlah</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="noData" style="display:none;padding:12px;color:var(--muted)">Tidak ada data pemesanan.</div>

        <div class="export">
            <button id="btnExcel" class="btn btn-primary">‚¨áÔ∏è Ekspor ke Excel</button>
            <button id="btnPDF" class="btn btn-outline">üßæ Ekspor ke PDF</button>
            <button id="btnPrint" class="btn btn-secondary">üñ®Ô∏è Cetak Langsung</button>
        </div>
    </main>

    <footer>¬© 2025 Toko Buku UT</footer>

    <!-- Modal Detail Pesanan -->
    <div id="detailModal">
        <div id="detailBox">
            <h3>Detail Pesanan</h3>
            <table id="tabelDetail">
                <thead>
                    <tr>
                        <th>Nama Buku</th>
                        <th>Jumlah</th>
                        <th>Harga</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button id="closeDetail" class="btn btn-outline">Tutup</button>
        </div>
    </div>

    <!-- Libraries -->
    <script src="theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        const user = JSON.parse(localStorage.getItem('userLogged'));
        if (!user || user.role !== 'Admin') {
            alert('Akses khusus admin!');
            location.href = 'login.html';
        }

        const tbody = document.querySelector('#tabelLaporan tbody');
        const noData = document.getElementById('noData');
        const cariInput = document.getElementById('cariNama');
        const filterSelect = document.getElementById('filterStatus');
        const ctx = document.getElementById('chartStatus').getContext('2d');
        let chart;

        let historyData = JSON.parse(localStorage.getItem('historyData') || '[]');
        let trackingData = JSON.parse(localStorage.getItem('trackingData') || '{}');
        let checkoutDetail = JSON.parse(localStorage.getItem('checkoutDetail') || '{}');

        // üîπ Rekap
        function hitungRekap(data) {
            const totalPesanan = data.length;
            const totalBuku = data.reduce((sum, d) => sum + (parseInt(d.jumlah) || 0), 0);
            const totalUang = data.reduce((sum, d) => sum + parseInt(d.total.replace(/\D/g, '')), 0);
            document.getElementById('rekapPesanan').textContent = totalPesanan;
            document.getElementById('rekapJumlah').textContent = totalBuku;
            document.getElementById('rekapPendapatan').textContent = "Rp " + totalUang.toLocaleString('id-ID');
            updateChart(data);
        }

        // üîπ Grafik
        function updateChart(data) {
            const statusList = ["Menunggu Konfirmasi", "Dalam Proses", "Dikirim", "Selesai"];
            const count = statusList.map(s => data.filter(d => d.status === s).length);
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: statusList,
                    datasets: [{
                        label: 'Jumlah Pesanan',
                        data: count,
                        backgroundColor: ['#fbbf24', '#60a5fa', '#34d399', '#a78bfa']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Status Pesanan',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            });
        }

        // üîπ Tabel utama
        function render(data) {
            tbody.innerHTML = '';
            if (data.length === 0) {
                noData.style.display = 'block';
                hitungRekap([]);
                return;
            }
            noData.style.display = 'none';
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${item.no}</td>
          <td>${item.nama}</td>
          <td>${item.tanggal}</td>
          <td>${item.jumlah}</td>
          <td>${item.total}</td>
          <td class="status">${item.status}</td>
          <td>
            <button class="btn btn-outline" data-detail="${item.no}">Detail</button>
            <select data-index="${index}" class="ubahStatus">
              <option value="">--Ubah Status--</option>
              <option>Menunggu Konfirmasi</option>
              <option>Dalam Proses</option>
              <option>Dikirim</option>
              <option>Selesai</option>
            </select>
          </td>`;
                tbody.appendChild(tr);
            });
            hitungRekap(data);
        }

        render(historyData);

        // üîπ Filter
        function applyFilters() {
            const namaCari = cariInput.value.toLowerCase();
            const statusCari = filterSelect.value;
            const filtered = historyData.filter(item =>
                item.nama.toLowerCase().includes(namaCari) &&
                (!statusCari || item.status === statusCari)
            );
            render(filtered);
        }
        cariInput.addEventListener('input', applyFilters);
        filterSelect.addEventListener('change', applyFilters);

        // üîπ Ubah status
        document.addEventListener('change', e => {
            if (!e.target.classList.contains('ubahStatus')) return;
            const idx = e.target.dataset.index;
            const newStatus = e.target.value;
            if (!newStatus) return;
            const item = historyData[idx];
            item.status = newStatus;
            localStorage.setItem('historyData', JSON.stringify(historyData));
            const kode = item.no;
            trackingData[kode] = trackingData[kode] || {
                nomorDO: kode,
                nama: item.nama,
                ekspedisi: '-',
                tanggalKirim: item.tanggal,
                paket: '-',
                total: item.total,
                status: newStatus,
                perjalanan: []
            };
            trackingData[kode].status = newStatus;
            trackingData[kode].perjalanan.push({
                waktu: new Date().toLocaleString('id-ID'),
                keterangan: `Status diubah menjadi: ${newStatus}`
            });
            localStorage.setItem('trackingData', JSON.stringify(trackingData));
            if (typeof showNotify === 'function') showNotify('Status pesanan diperbarui ‚úÖ', 'success');
            applyFilters();
        });

        // üîπ Detail pesanan
        document.addEventListener('click', e => {
            if (e.target.dataset.detail) {
                const kode = e.target.dataset.detail;
                const detail = checkoutDetail[kode] || [];
                const tbodyD = document.querySelector('#tabelDetail tbody');
                tbodyD.innerHTML = '';
                detail.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${d.nama}</td><td>${d.jumlah}</td><td>Rp ${d.harga.toLocaleString()}</td>`;
                    tbodyD.appendChild(tr);
                });
                document.getElementById('detailModal').style.display = 'flex';
            }
        });
        document.getElementById('closeDetail').addEventListener('click', () => {
            document.getElementById('detailModal').style.display = 'none';
        });
        document.getElementById('detailModal').addEventListener('click', e => {
            if (e.target.id === 'detailModal') e.target.style.display = 'none';
        });

        // üîπ Ekspor Excel
        document.getElementById('btnExcel').addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet(historyData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            XLSX.writeFile(wb, "Laporan_Pemesanan.xlsx");
        });

        // üîπ Ekspor PDF
        document.getElementById('btnPDF').addEventListener('click', () => {
            const {
                jsPDF
            } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Laporan Pemesanan Toko Buku UT", 14, 16);
            doc.autoTable({
                startY: 22,
                head: [
                    ['Kode DO', 'Nama', 'Tanggal', 'Jumlah', 'Total', 'Status']
                ],
                body: historyData.map(h => [h.no, h.nama, h.tanggal, h.jumlah, h.total, h.status]),
            });
            doc.save('Laporan_Pemesanan.pdf');
        });

        // üîπ Cetak
        document.getElementById('btnPrint').addEventListener('click', () => window.print());
    </script>
</body>

</html>